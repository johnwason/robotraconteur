name: Build Dist

on:
  push:
  pull_request:
  release:
    types:
      - created

jobs:
  build-dist:
    runs-on: ubuntu-20.04
    env:
      COMMIT_SHA: 4e1c4eeb897a331a973a99a2ced79518286528d4
    steps:
    - uses: actions/checkout@v2
      with:
        path: robotraconteur
    - uses: nuget/setup-nuget@v1
    - name: Download CI artifacts
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: main.yml
        commit: ${{ env.COMMIT_SHA }}
        path: artifacts/main
        workflow_conclusion: success
    - name: Download Build Python Version artifacts
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: build_python_version.yml
        commit: ${{ env.COMMIT_SHA }}
        path: artifacts/build_python_version
        workflow_conclusion: success
    - name: collect source
      run: python robotraconteur/packaging/scripts/collect_source.py
    - name: collect wheels
      run: python robotraconteur/packaging/scripts/collect_wheels.py
    - name: collect matlab
      run: python robotraconteur/packaging/scripts/collect_matlab.py
    - name: build java zip
      run: python robotraconteur/packaging/scripts/build_java_zip.py
    - name: build nuget package
      run: python robotraconteur/packaging/scripts/build_nuget_package.py
    - name: archive distfiles
      uses: actions/upload-artifact@v2
      with:
        name: 'distfiles'
        path: distfiles/*
  build-vcpkg-port:
    runs-on: windows-2016
    env:
      GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    steps:
    - uses: actions/checkout@v2
      with:
        path: robotraconteur
    - name: config portfile
      run: python robotraconteur/packaging/scripts/build_vcpkg_port.py
    - name: archive distfiles
      uses: actions/upload-artifact@v2
      with:
        name: 'vcpkg-robotraconteur'
        path: vcpkg-robotraconteur/*
    - name: build vcpkg
      run: >
        vcpkg install --triplet x64-windows --overlay-ports=vcpkg-robotraconteur\ports robotraconteur
    